<html>
<head>
    <title>Api Call</title>
    <script src="jquery-3.4.1.min.js"></script>
    <script type="text/javascript">
        var separator = "\r\n" + "----" + "\r\n";
        var baseUrl = '';
        var client_id = '';
        var client_secret = 'secret';

        jQuery(document).ready(function () {
            setBaseValues();
            mytestfunc();
        });

        function mytestfunc() {
            //saveprofile();
            uploadDataTest();
        }

        function setBaseValues() {
            baseUrl = 'http://localhost:5000/api/v1';
            //baseUrl   = 'https://192.168.41.93/api/v1';

            client_id = "c029711e-c6ac-4adb-8084-63520a238eb2";//My computer
            //client_id = '56982099-86d3-4e64-be00-c4a2796148a4';//My home computer
            //client_id= '864e4d8d-c3eb-4ac6-a225-e09862ca94c7';//test server
        }

        function uploadDataTest() {
            var arr = { "FirstName": "Salam" };
            defaultForm("/test1/upload", arr);
        }

        function downloadTets() {
            var arr = { fileid: "86af957c-3b14-4a32-a50d-8111d3cb4163" };
            var token = callLogin("d5749b25-71c1-4598-ac99-2d5348afc2cd@yahoo.com", "123456", false);
            downloadFile(arr, "/file/download", token);
        }

        function defaultForm(url, dataJson, myFunc) {
            $("form#data").submit(function (e) {
                e.preventDefault();
                uploadFileWithData(this, url, dataJson, ["image", "image1"], myFunc);
            });
        }

        function uploadFileWithData(from, url, dataJson, filesElementIds, myFunc) {
            //var token = callLogin('CSharp@yahoo.com','123456',false);
            var token = callLogin();
            console.log('token : ' + token);
            var authorizationHeader = 'Bearer ' + token;

            var formData = new FormData(from);
            formData.append('data', JSON.stringify(dataJson));

            for (var i = 0; i < filesElementIds.length; i++) {
                formData.append('files', $('#' + filesElementIds[i]).get(0).files[0]);
            }

            $.ajax({
                url: baseUrl + url,
                //beforeSend: function (request) {
                //    request.setRequestHeader("Authorization:", "Bearer " + token);
                //},
                headers: {
                    'Authorization': authorizationHeader,
                },
                type: 'POST',
                data: formData,
                success: function (msg) {
                    success(msg);
                    if (myFunc != undefined) {
                        myFunc(token);
                    }
                }, error: function (xhr, ajaxOptions, thrownError) {
                    error(xhr, ajaxOptions, thrownError);
                },
                cache: false,
                contentType: false,
                processData: false
            });
        }


        function callLogin(email = '', password = '', register = true) {

            var url = '';
            var arr, token;

            if (email == '') {
                email = uuidv4() + '@yahoo.com';
            }
            if (password == '') {
                password = '123456';
            }
            if (register) {
                url = '/authenticate/register';
                arr = { email: email, password: password };

                json(arr, url);
            }
            arr = { "grant_type": "password", "username": email, "password": password, "client_id": client_id, "client_secret": client_secret, "scope": "openid offline_access" },
                url = '/authenticate/connect/token';

            var msg = formurlencoded(arr, url);

            if (msg != undefined)
                token = msg.model.access_token;
            return token;
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function formurlencoded(arr, url) {
            var result;
            $.ajax({
                url: baseUrl + url,
                type: 'POST',
                data: arr,
                contentType: "application/x-www-form-urlencoded",
                dataType: 'json',
                async: false,
                success: function (msg) {
                    success(msg);
                    result = msg;
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    error(xhr, ajaxOptions, thrownError);
                }
            });
            return result;
        }

        function downloadFile(arr, url, token) {
            var authorizationHeader = GetAuthorizationHeader(token);
            $.ajax({
                cache: false,
                headers: {
                    'Authorization': authorizationHeader,
                },
                url: baseUrl + url,
                type: 'POST',
                data: JSON.stringify(arr),
                contentType: 'application/json; charset=utf-8',
                xhrFields: {
                    // make sure the response knows we're expecting a binary type in return.
                    // this is important, without it the excel file is marked corrupted.
                    responseType: 'arraybuffer'
                }
            }).done(function (data, status, xmlHeaderRequest) {
                var downloadLink = document.createElement('a');
                var blob = new Blob([data],
                    {
                        type: xmlHeaderRequest.getResponseHeader('Content-Type')
                    });
                var url = window.URL || window.webkitURL;
                var downloadUrl = url.createObjectURL(blob);
                var fileName = '';

                // get the file name from the content disposition
                var disposition = new XMLHttpRequest().getResponseHeader('Content-Disposition');
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    var matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        fileName = matches[1].replace(/['"]/g, '');
                    }
                }

                // Blob download logic taken from: https://stackoverflow.com/questions/16086162/handle-file-download-from-ajax-post
                if (typeof window.navigator.msSaveBlob !== 'undefined') {
                    // IE workaround for "HTML7007" and "Access Denied" error.
                    window.navigator.msSaveBlob(blob, fileName);
                } else {
                    if (fileName) {
                        if (typeof downloadLink.download === 'undefined') {
                            window.location = downloadUrl;
                        } else {
                            downloadLink.href = downloadUrl;
                            downloadLink.download = fileName;
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                        }
                    } else {
                        window.location = downloadUrl;
                    }

                    setTimeout(function () {
                        url.revokeObjectURL(downloadUrl);
                    },
                        100);
                }
            });
        }

        function json(arr, url, token) {
            var authorizationHeader = GetAuthorizationHeader(token);
            $.ajax({
                headers: {
                    'Authorization': authorizationHeader,
                },
                url: baseUrl + url,
                type: 'POST',
                data: JSON.stringify(arr),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                async: false,
                xhrFields: {
                    // make sure the response knows we're expecting a binary type in return.
                    // this is important, without it the excel file is marked corrupted.
                    responseType: 'arraybuffer'
                },
                success: function (msg) {
                    //success(msg);
                    saveFile(msg);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    error(xhr, ajaxOptions, thrownError);
                }
            });
        }

        function success(msg) {
            msg = JSON.stringify(msg);
            //alert(msg);
            console.log(msg);
        }

        function saveFile(data) {
            var downloadLink = document.createElement('a');
            var blob = new Blob([data],
                {
                    type: xmlHeaderRequest.getResponseHeader('Content-Type')
                });
            var url = window.URL || window.webkitURL;
            var downloadUrl = url.createObjectURL(blob);
            var fileName = '';

            // get the file name from the content disposition
            var disposition = xmlHttpRequest.getResponseHeader('Content-Disposition');
            if (disposition && disposition.indexOf('attachment') !== -1) {
                var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                var matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                    fileName = matches[1].replace(/['"]/g, '');
                }
            }

            // Blob download logic taken from: https://stackoverflow.com/questions/16086162/handle-file-download-from-ajax-post
            if (typeof window.navigator.msSaveBlob !== 'undefined') {
                // IE workaround for "HTML7007" and "Access Denied" error.
                window.navigator.msSaveBlob(blob, fileName);
            } else {
                if (fileName) {
                    if (typeof downloadLink.download === 'undefined') {
                        window.location = downloadUrl;
                    } else {
                        downloadLink.href = downloadUrl;
                        downloadLink.download = fileName;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                    }
                } else {
                    window.location = downloadUrl;
                }

                setTimeout(function () {
                    url.revokeObjectURL(downloadUrl);
                },
                    100);
            }
        }

        function GetAuthorizationHeader(token) {
            if (token != undefined) {
                return 'Bearer ' + token;
            }
            return "";
        }

        function error(xhr, ajaxOptions, thrownError) {
            alert(xhr.status + separator + thrownError + separator + xhr.responseText);
        }

    </script>
</head>
<body>
    <button onclick="callLogin()">Login</button>
    <button onclick="supportedCoin()">SupportedCoin</button>
    <button onclick="downloadTets()">downloadTets</button>

    <br />
    <br />
    <br />
    <br />
    <form id="data" method="post" enctype="multipart/form-data">
        <input type="text" name="FirstName" value="Salam" />
        <input id="image" name="image" type="file" />
        <input id="image1" name="image1" type="file" />
        <button>Send</button>
    </form>
</body>
</html>
